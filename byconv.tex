\subsection{Построение множества методами многозначного анализа.}

Перейдем к поиску решения задачи \eqref{eq:mainsystem} c помощью оценивания множеств методами многозначного анализа.

В отличие от первого подхода, где была найдена функция, полностью характеризующая решение сразу для двух систем уравнений и условия на переключение, теперь будем рассматривать каждый этап по отдельности.

\subsubsection{Множество достижимости  до переключения.}
\label{par_conv1}
Для системы дифференциальных уравнений 
\begin{equation}
\left\{
		    \begin{aligned}
		        &\dot x^{(1)} = A^{(1)}(t)x^{(1)}+B^{(1)}(t)u^{(1)}(t)+C^{(1)}(t)v^{(1)}(t);\\
		        &x(t_0)\in\mathcal{E}(x_0,X_0)=\mathcal{X}_0;\\
		        &u^{(1)}(t)\in\mathcal{E}(p^{(1)}(t),P^{(1)}(t))=\mathcal{P}^{(1)}[t_0,t_1];\\
						&v^{(1)}(t)\in\mathcal{E}(w^{(1)}(t),W^{(1)}(t))=\mathcal{V}^{(1)}[t_0,t_1];\\
		    \end{aligned}
\right.
\label{eq:mainsys_p1}
\end{equation}
требуется найти множество достижимости по \defref{def:XX1}. 

Это эквивалентно следующей задаче. Пусть нам даны множества $\XX_0[t]$~--исходное множество, $\mathcal{P}(t)$~--множество допустимых управлений, $\mathcal C(t)$~-- множество помех, $X_0$, $\mathcal P(t)$, $\mathcal C(t)$~-- выпуклые. Гарантированное множество достижимости находится как
$$
\XX[t]=\left(\XX_0[t]\dot-\mathcal C(t) \right) + \mathcal P(t).
$$
Здесь операция $\dot-$~--- \textit{геометрическая разность} (разность Минковского) двух компактных множеств.
\begin{define}
Геометрической разностью выражения $C=A\dot-B$ называется множество $C=\{c\mid c+B\subseteq A\}$.
\end{define}

Решение задачи Коши для системы \eqref{eq:mainsys_p1}
$$
x(t)=G(t_0,t_1)x_0+\intd{t_0}{t_1}G(t_1,s)B(s)u(s)ds+\intd{t_0}{t_1}C(s)v(s)ds,
$$
где $x(t)$ -- траектория системы, определяется выбранным управлением $u(\cdot)$ и неизвестной реализацией помехи $v(\cdot)$.
Тогда гарантированная оценка множества достижимости имеет решение в виде
$$
\XX[t]=\left(G(t_0,t_1)\XX_0\dot-\intd{t_0}{t_1}G(t_1,s)\VV(s)ds\right)+\intd{t_0}{t_1}G(t_1,s)B(s)\PP(s)ds.
$$

Поскольку напрямую решать данные интегралы от множеств затруднительно, прибегнем к аппарату эллипсоидальных оценок \mycite{ABK_upr_i_nabl,ABK_internal_approx,ABK_int_i_ext_approx}. Мы можем оценить искомое множество  через внешние и внутренние эллипсодальные оценки. Так что 
$$
\XX[t]\subseteq \bigcap_\ell\Ell(q^\ell_+(t),Q^\ell_+(t));
$$
$$
\XX[t]\supseteq \bigcup_\ell\Ell(q^\ell_-(t),Q^\ell_-(t)),
$$
где $\ell$ -- вектор, в направлении которого оценивающий эллипсоид касается искомого множества, $\Ell(q^ell_+(t),Q^\ell_+(t))$ -- внешняя эллипсоидальная оценка, $\Ell(q^\ell_-(t),Q^\ell_-(t)$ -- внутренняя эллипсоидальная оценка.
Поскольку ограничения на начальные условия, управление, помеху в задаче \eqref{eq:mainsys_p1} выражены эллипсоидами, выпуклыми компактами, то само $\XX[t]$ -- также будет выпуклым \mycite{ABK_int_i_ext_approx} и справедливо
$$
\bigcup_{\forall \ell}\Ell(q^\ell_-(t),Q^\ell_-(t))=\XX[t]=\bigcap_{\forall \ell}\Ell(q^\ell_+(t),Q^\ell_+(t)),
$$
где пересечение и объединение берутся по всем возможным направлениям  $\ell\in\rdim{n}$.

Параметры внутренней эллипсоидальной оценки $\Ell(q^\ell_-(t),Q^\ell_-(t))$ берутся из уравнения
\begin{equation}
\begin{gathered}\dot Q_-(t)=A(t)Q_-(t)+Q_-(t)A^T(t)+Q^{-\frach}_-(t)S(t)P^{\frach}(t)B(t)+B(t)P^{\frach}(t)B^T(t)S^T(t)Q^{\frach}_-(t)-\\
-\pi(t)Q_-(t)-\pi^{-1}(t)C(t)W(t)C^t(t),\\
\dot q_-(t)=A(t)q(t)+B(t)p(t)+C(t)w(t),
\end{gathered}
\end{equation}
где $S(t)$,$\pi(t)$ удовлетворяют соотношениям
$$
S(t)P^{\frach}(t)B^T(t)\ell(t)=Q^{\frach}_-(t)\ell(t)\lambda(t),
$$
$$
\pi(t)=\frac{ \ts{\ell(t),C(t)W(t)C^T(t)\ell(t)}^{\frach}} {\ts{\ell(t),Q_-(t)\ell(t)}^{\frach}},
$$
$$
\lambda(t)=\frac{ \ts{\ell(t),B(t)P(t)B^T(t)\ell(t)}^{\frach} }  { \ts{\ell(t),Q_-(t)\ell(t)}^{\frach} }, \quad\ell(t)=G^T(t,t_0)\ell_0,\;\ell_0\in\rdim{n}.
$$

Параметры внешней эллипсоидальной оценки $\Ell(q_+(t),Q_+(t))$ находятся из
\begin{equation}
\begin{gathered}
\dot Q_+=A(t)Q_-(t)+Q_-(t)A^T(t) + \pi(t)Q_+(t)+\pi^{-1}(t)B(t)P(t)B^T(t) - \\ -Q^{\frach}_+(t)S(t)W^{\frach}(t)C^T(t)-C(t)W^{\frach}(t)S^T(t)Q^{\frach}_+(t),
\end{gathered}
\end{equation}
где
$$
S(t)W^{\frach}(t)C^T(t)\ell(t)=\lambda(t)Q^{\frach}(t)\ell(t),
$$
$$
\pi=\frac{ \ts{\ell(t),B(t)P(t)B^T(t)\ell(t)}^{\frach}}  { \ts{\ell(t),Q_+(t)\ell(t)}^{\frach}},
$$
$$
\lambda(t)=\frac{\ts{\ell(t),C(t)W(t)C^T(t)\ell(t)}^{\frach}}  { \ts{\ell(t),Q_+(t)\ell(t)}^{\frach} },\quad\ell(t)=G^T(t,t_0)\ell_0,\;\ell_0\in\rdim{n}
$$

Итак, c помощью эллипсоидальных оценок мы можем вычислить сколь угодно точную оценку множества достижимости $\XX^{(1)}[t,t_0,\XX_0]$ (по Опр.\ref{def:XX1}) для любого момента времени $t$ и начального условия $\XX_0$.

Необходимо отметить, что $\XX[t,t_0]$ образовано двумя множествами:
$$\left(G(t_0,t_1)\XX_0\dot-\intd{t_0}{t_1}G(t_1,s)\VV(s)\right)$$ обеспечивает множество гарантированного попадания, а другое, $\intd{t_0}{t_1}G(t_1,s)B(s)\PP(s)$ --  желаемое смещение первого множества.
Кроме того, может оказаться, что начиная с некоторого $\tau>t$, $\XX[t,t_0]$  окажется пустым, если $\left(\XX_0[t]\dot-\mathcal C(t) \right)$ выродится.
Соответственно, расчет для второй системы необходимо выполнять не с начальным множеством $\XX^{(1)}[t,t_0,\XX_0]\cap H(c,\gamma)$, а $\left(G(t_0,t_1)\XX_0\dot-\intd{t_0}{t_1}G(t_1,s)\VV(s)ds+\phi^\alpha\right)\cap H(c,\gamma)$,
где $\phi^\alpha=\intd{t_0}{t_1}G(t_1,s)B(s)p^\alpha(s)ds,\quad p^\alpha(\cdot)\in\PP(\cdot)$.
Поэтому, в дальнейшем, мы будем искать множество достижимости второй системы для фиксированного $p^\alpha(\cdot)$.



\subsubsection{Пересечение с гиперплоскостью.}
\newcommand{\CaH}{C^\alpha_H}
\newcommand{\phia}{\phi^\alpha}
\newcommand{\TTa}{\mathcal{T}^\alpha}
Рассмотрим теперь вычисление множеств, образованных пересечением множества достижимости первой системы с гиперплоскостью $H(c,\gamma)=\{x\mid \ts{x,c}=\gamma\}$. 
Пусть 
$$
\begin{gathered}
C(s)\defeq\left(G(t_0,t_1)\XX_0\dot-\intd{t_0}{t_1}G(t_1,s)\VV(s)ds\right),\\
\phia(t)\defeq\intd{t_0}{t}G(t_1,s)B(s)u^\alpha(s)ds,\\
\CaH(s)\defeq\left(C(s)+\phia(s)\right)\cap H\\
\TTa\defeq\{\tau\mid \CaH[\tau]\neq\emptyset\}=[\tau^\alpha_1,\tau^\alpha_2]
\end{gathered}
$$
Мы предполагаем условие односторонней трансверсальности выполненным, поэтому можем утверждать, что множество $\CaH(\TTa)$ -- односвязное.
Вслучае невыполнения условий трансверсальности , множество $\CaH(\TTa)$ может быть несвязным, в этом случае дальнейший анализ существенно затруднится \epicref{pic:transv}.
\labtwinimage{transv1}{transv2}{8}{Выполнение и невыполнение условий трансверсальности.}{pic:transv}

В пункте \ref{par_conv1} мы нашли оценку множества достижимости с помощью эллипсоидальных оценок.
Вычислим теперь $\CaH[\tau]$

\begin{propose}[\mycite{ABK_hyb_sys}] Пусть эллипсоид $\mathcal{E}(q,Q)$ и ги\-пер\-плоскость $\mathcal{H}=\{x\in\mathbb{R}^n:\;\langle x,c\rangle=\gamma\}$ таковы, что
$\mathcal{E}\cap\mathcal{H}\neq \emptyset$. Тогда $\mathcal{E}(q,Q)\cap\mathcal{H} = \mathcal{E}(\tilde{q},\tilde{Q})$ - вырожденный эллипсоид
(т.е. $\tilde{Q}=\tilde{Q}^T\geqslant0,\;det(\tilde{Q})=0$).
\end{propose}
{\it Доказательство.} Пусть $T\in\mathbb{R}^{n\times n}$ - такая невырожденная матрица, что $Tc=e_1$, где $e_1=(1,0,\ldots,0)$. Используя замену переменных
$x=T'y$ и $q=T'p$, преобразуем множество $\mathcal{E}(q,Q)\cap\mathcal{H}$:

$$
\begin{aligned}
\mathcal{E}(q,Q)\cap\mathcal{H}&=\{x\in\mathbb{R}^n:\langle x-q,Q^{-1}(x-q)\rangle \leqslant1,\langle x,c \rangle=\gamma\}=\\
&T'\{y=(\gamma,z)',z\in\mathbb{R}^{n-1}:\langle z-\tilde{q},\tilde{Q}(z-\tilde{q})\rangle \leqslant 1\}
\end{aligned}
$$
$$
TQ^{-1}T'=\left(\begin{array}{ccc} a & c' \\ c & D \end{array} \right),\;D\in\mathbb{R}^{(n-1)\times(n-1)},p=\left(\begin{array}{ccc} p_1 \\ \tilde{p} \end{array}\right),\tilde{p}\in\mathbb{R}^{n-1}
$$
$$
\tilde{q}=\tilde{p}-D^{-1}(\gamma-p_1)c\;,\;A=\frac{D}{1-(\gamma-p_1)^2(a-\langle c,\;D^{-1}c\rangle)}
$$
И проверкой подстановки
$$
\tilde{q}=T'\left(\begin{array}{ccc} \gamma \\ \tilde{q} \end{array} \right),\tilde{Q}=T'\left(\begin{array}{ccc} 0 & 0\\ 0 & A^{-1} \end{array} \right)T
$$
завершаем доказательство утверждения.
Нам важно найти не столько вырожденный эллипсоид $\Ell(\tilde q,\tilde Q)$, сколько его пересечение с гиперплоскостью.
Легко видеть, что это будет эллипсоид с размерностью на единцу меньше, его параметры находятся как $q_H=\gamma D^{-1}c$, $Q_H=A^{-1}$. Вектор $q_H$ указывает смещение эллипсоида относительно опущенного на плоскость перпендикуляра, выпущенного из центра пересекаемого эллипсоида \epicref{pic:ellips_ints_H}.

\labimage{ellips_ints_H2D}{7}{Пересечение эллипсоида с плоскостью.}{pic:ellips_ints_H}

Таким образом, для момента времени $\tau\in\TTa$ мы получили семейство эллипсоидов размерности на единицу меньше, расположенные на плоскости $H$, которые, в свою очередь оценивают искомое сечение множества пересечения, которое остается выпуклым. Это семейство внутренних и внешних оценок также можно оценивать новыми оценками, с целью уменьшения дальнейших вычислений.

\subsubsection{Вычисление множества достижимости для второй системы}

На данном этапе у нас имеется семейство $(\TTa,\CaH(\TTa))$, которое является начальным условием для задачи 
\labform{
	\left\{
	    \begin{aligned}
	        &\dot x^{(2)} = A^{(2)}(t)x^{(2)}+B^{(2)}(t)u^{(2)}(t)+C^{(2)}(t)v^{(2)}(t);\\
	        &x(\tau)\in\CaH[\tau],\;\tau\in\TTa\\
	        &u^{(2)}(t)\in\mathcal{E}(p^{(2)}(t),P^{(2)}(t))=\mathcal{P}^{(2)}[t_0,t_1];\\
					&v^{(2)}(t)\in\mathcal{E}(w^{(2)}(t),W^{(2)}(t))=\mathcal{V}^{(2)}[t_0,t_1];\\
	    \end{aligned}
	\right.
}{eq:mainsys_p2}

Мы не можем построить множество достижимости так же как и для первой системы, поскольку здесь начальные условия ''распределены'' во времени, и соответственно это надо учитывать, что отличает эту задачу от предыдущей. Здесь можно воспользоваться методами решения задач с фазовыми ограничениями \cite{ABK_ellipse_for_reach_under_state_constraints}, но в отличие от них нам требуется учитывать неопределённость. Гарантированная оценка множества достижимости $\XX^\alpha_2[t,t_0]$ для \eqref{eq:mainsys_p2} описывается как
\labform{
\begin{gathered}
\XX^\alpha_2[t_1]=\{x_2\mid \exists u_2(\cdot)\in \PP^{(2)}[t_0,t_1]: \forall v_2(\cdot)\in \VV^{(2)}[t_0,t_1]: \\ 
\exists \tau\in\TTa,x_h(\tau)\in\CaH[\tau]: x(t,\tau,x_h(\tau),u_2(\cdot),v_2(\cdot))=x2\}
\end{gathered}
}{eq:attain_set_2}
Найдем множество точек в момент времени $\tau$, из которых мы можем прийти в точку $x_2=0$ в конечным момент $t_1$ при некотором фиксированном управлении. 
\newcommand{\QQ}{\mathcal{Q}}
$$
\QQ[\tau] = \intd{t_1}{\tau}\VV_2(s)ds 
$$ 

Согласно \eref{eq:attain_set_2} 
\labform{\forall \tau\in \TTa: (\xi(\tau)+\QQ[\tau])\cap H \subseteq \CaH[\tau],\quad \mbox{где}
}{eq:bounds}  $$ \xi(\tau)= x_2+\intd{t_1}{\tau}u_2(s)ds.$$
Найдем множество фазовых ограничений
$$
Z[\tau]=\{\xi(\tau)\mid (\xi(\tau)+\QQ[\tau])\cap H \subseteq \CaH\}
$$
Для любого $\xi(\tau)\in Z[\tau]$  выполнено \eref{eq:bounds}. 
Используя свойство выпуклости и симметрии множества $\QQ[\tau]$, находим $Z[\tau]$ как 
дополнение ко множеству всех точек $\tilde{\xi}(\tau)$, в которых $(\tilde{\xi}(\tau)+\QQ[\tau])$ касается $(H\setminus \CaH[\tau])$ или 
$$
Z[\tau]=\overline{ H\setminus \CaH[\tau] + \QQ[\tau]},
$$
что проиллюстрировано на \picref{bset_xi}.
\labimage{bset_xi_H}{10}{Множество фазовых ограничений}{bset_xi}
Легко видеть, что оно строиться как дополнение к некоторому семейству выпуклых множеств, и в данном случае для любых $\QQ[\tau]$, $\CaH[\tau]$  не может быть выпуклым, что является ограничением для вычисления множества достижимости c учетом фазовых ограничений $Z[\tau]$. Поэтому, будем решать задачу поиска множества достижимости при условии огибания препятствия $\overline{Z[\tau]}$. Поскольку множество $\overline{Z[\tau]}$ состоит из множества эллипсоидов (эллипсоидальные оценки множества $\QQ[\tau]$), выделим среди них те, которые непосредствено примыкают к $Z[\tau]$, тогда мы можем обойти только считанные из них (для момента $\tau$ ), и попасть на целевое множество $\XX^\alpha_2[t_1]$, Центры всех примыкающих эллипсоидов  расположены на границе $\CaH[\tau]$. Если мы решаем задачу в $\rdim{1}$, то множество $\CaH[\tau]$- это точка, множество примыкающих эллипсоидов состоит из отрезка с центром в этой точке. Для адачи в $\rdim{2}$, $\CaH[\tau]$~-- отрезок, концы которого служат центрами для выбранных эллипсоидальных оценок $\QQ[\tau]$, см. \picref{bset_xi}.
Для $\rdim{n}, n\ge3$, множество $\CaH[\tau]$ образует замкнутую линию ($n=3$), или поверхность ($n>3$), так что задача существенно усложняется. 

Итак мы нашли условия на фазовые ограничения для траекторий $\xi(\tau)$, таких, что выполняется \eqref{eq:bounds}. Из условий \eqref{eq:attain_set_2} и трансверсальности \eqref{eq:perehod} мы обнаруживаем, что, для того, чтобы траектория $\xi(\cdot)$ принадлежала множеству $\XX_2[t_1]$ достаточно, чтобы она входила во множество $Z[\tau_1]$, в любой из моментов $\tau_1\in\TTa$, и покидало множество $Z[\tau_2]$ в любой момент $\tau_2\in \TTa, \tau_2>\tau_1$.
Можно обозначить множество $X^{(2)}_0[\tau^\alpha_1]=\{x\mid x \le H+\QQ[\tau^\alpha_1]$ как начальное множество в момент $\tau^\alpha_1$ для задачи поиска множества достижимости с фазовыми ограничениями на огибание препятствия.
Поскольку данное множество  $X^{(2)}_0$~-- задаёт полупространство, а мы хотим эллипсоидальную оценку, можно выбрать достаточно большой эллипсоид, который позволит нам для любого момента $\tau\in\TTa$ полностью накрывать траекториями нижнюю границу (lower boundary на \picref{bset_xi}), двигаясь вверх (согласно правилу односторонней проницаемости).  

\cmnt{Официальная часть кончилась, дальше идут краткие рассуждения} 

Осталось пройти сквозь коридор $Z[\tau]$.

\cmnt{Взято из лекций:}
Идея огибания строится так: дан эллипсоид $\Ell(q(t),Q)$, который нужно обойти. траектория $x(t)$ смещается так, чтобы было $\Ell(0,Q)$ (\cmnt{Это меня смущает}). далее мы переходим к условию выполнения неравенства $\ts{\ell^0(t),x(t)}\ge 1$, где $\ell^0(\cdot)$~-- специально найденные направления, чтобы не проверять $d^2(x(t),\Ell(0,Q))>0$.
Далее от этого неравентва берется интеграл с ограниченными вариациями и выписывается неравенсто, чтобы получилось
$$
p^T x_2 \le \min_{\Lambda,p} \Phi(\Lambda,p),
$$
из которого можно найти достижимость ( выпуклость $\Phi$ дает опорную функцию $\supfn{p}{X_2}$ )
Проделываем это для каждого эллипсоида, берем пересечение множеств достижимости (потому что  траектории должны проходить между ними.)

и вроде все.

Осталось сделать еще один рисунок с изображениями фазовых ограничений во времени, но это опционально. 
Еще два рисунка с одномерными множествами, которые еще предстоит вставить в контекст.

\twinimage{x2simple}{notsimplex2}{7}{Множество достижимости в $\rdim{1}$}

