
\section{Пример}

Заданы системы дифференциальных уравнений, описывающих состояние некоторой модели до переключения и после:
\begin{equation}
\left\{
\begin{aligned}
			%\begin{aligned}
			&\left[
			\begin{aligned}
			    &\left\{
					    \begin{aligned}
					        &\dot x_1^{(1)} = x_2^{(1)}+v^{(1)}(t);\\
					        &\dot x_2^{(1)} = u^{(1)}(t);\\
					        &x(t_0)\in\mathcal{X}_0=\{x\in \mathbb{R}^2:(x_1-2)^2+(x_2-1)^2\leqslant1\};\\
					    \end{aligned}
			    \right.\\
			    \\
			    &\left\{
					    \begin{aligned}
					        &\dot x_1^{(2)} = x_2^{(2)}+v^{(2)}(t);\\
					        &\dot x_2^{(2)} = -\gamma x_1 -\mu x_2 + u^{(2)}(t);\\
					        &x(\tau)\in\mathcal{X}^{(1)}[\tau,t_0]\cap\mathcal{H},\tau\leqslant t\leqslant t_1;
					    \end{aligned}
					\right.\\
			\end{aligned}
			\right.\\
			\\
			&\mathcal{H}=\{x\in \mathbb{R}^2: x_1=0\}\mbox{--- гиперплоскость};\\
			&u(\cdot)\in[-\alpha_1,\alpha_2]=\mathcal{P}[t_0,t_1],\;v(\cdot)\in[-\beta_1,\beta_2]\in\mathcal{W}[t_0,t_1];\\
			&\gamma,\mu,\alpha_1,\alpha_2,\beta_1,\beta_2 > 0\mbox{--- некоторые константы};\\
			&\tau \mbox{ --- момент  переключения, при пересечении гиперплоскости}.\\
\end{aligned}
\right.
\label{eq:primer_sys}
\end{equation}


Для поиска множества $\mathcal{X}[t,t_0]$ будем использовать функцию цены
$$
%%\label{eq:value_f}
V(t,x)=\min_{u(\cdot)}\max_{v(\cdot)}d^2(x_0,\mathcal{X}_0)\mid_{x(t)=x}
$$

где $d(x_0,\mathcal{X}_0)$ - расстояние между точкой $x_0$ и множеством $\mathcal{X}_0$, определяемое метрикой
$d(x,\mathcal{X})=\min_{y\in\mathcal{X}} \|x-y\|$.

Пусть $\phi(x)=d^2(x_0,\mathcal{X}_0)$, сопряженная к ней:
$$
\phi^{*}(\ell)=\sup_{x}( \ts{x,\ell} -  d^2(x,\mathcal{X}_0)) = \rho(\ell\mid\mathcal{X}_0)+\frac{\|\ell\|^2}{4},
$$

тогда

\begin{equation}
\label{eq:valued2}
V(t,x)=\min_{u(\cdot)}\max_{v(\cdot)}\sup_{\ell}\left(\ts{\ell,x_0} - \rho(\ell\mid\mathcal{X}_0)-\frac{\|\ell\|^2}{4}\right).
\end{equation}

%
%
%Выпишем теперь решение $x(t,t_0,x_0)$  для первой системы из \eqref{eq:primer_sys}
%$$
%\begin{aligned}
%x^{(1)}_2(t,t_0)&=x^{(1)}_{02}+\int\limits_{t_0^{(1)}}^{t}u^{(1)}(s)\,ds;\\
%x^{(1)}_1(t,t_0)&=x^{(1)}_{01}+\int\limits_{t_0^{(1)}}^{t}\left( \int\limits_{t_0^{(1)}}^{\tau}u^{(1)}(s)\,ds + x^{(1)}_{02} \right)\,d\tau + \int\limits_{t_0^{(1)}}^{t} v^{(1)}(s)\, ds;\\
%\end{aligned}
%$$
%
%Решение для второй системы
%$$
%x^{(2)}(t,t^{(2)}_0)=G(t,t^{(2)}_0)x^{(2)}_0 + \int\limits_{\tau}^t G(t,s)\left(Bu(s)+Cv(s)\right)\,ds,
%$$
%где $G(t,s)=e^{A(t-s)},\,B={\begin{pmatrix} 0 \\ 1\end{pmatrix}},\,C={\begin{pmatrix} 1 \\ 0\end{pmatrix}},A={
%\begin{pmatrix}
%0 & 1\\
%-\gamma & -\mu
%\end{pmatrix}} $

Найдем выражения для поиска $x_0\mid_{x(t_1)=x}$.
Пусть траектория точки в момент $t_1$ известна $x(t_1)=x$.
Идя в обратном времени, найдем её значение в момент $t\leqslant t_1$ при известных $B(s),C(s),u(s),v(s)$ до переключения:
$$
x^{(2)}(t,x,u,v)=G_2(t,t_1)x+\int\limits_{t_1}^t G_2(t,s)\left[B_2(s)u_2(s)+C_2(s)v_2(s)\right]ds,\mbox{при}\, \tau\leqslant t \leqslant t_1,
$$
 и после:
\begin{equation}
\label{eq:solvex0}
\begin{aligned}
x^{(2,1)}(t,\tau,x,u,v)=&G_1(t,\tau)G_2(\tau,t_1)x+G_1(t,\tau)\int\limits_{t_1}^\tau G_2(t,s)\left[B_2(s)u_2(s)+C_2(s)v_2(s)\right]ds +\\ 
&+\int\limits_{\tau}^{t_0} G_1(t,s)\left[B_1(s)u_1(s)+C_1(s)v_1(s)\right]ds\,,\;\mbox{при}\, t_0 \leqslant t \leqslant \tau.
\end{aligned}
\end{equation}

Нам необходимо, чтобы момент $\tau$ в этих выражениях удовлетворял условию пересечения, так чтобы $\ts{x(\tau),c}=\gamma$.
Поскольку $\mathcal{X}[t,t_0]=\{x\mid V(t,x)\leqslant 0\}, \forall t\in[t_0,t_1]$, то достаточно ввести штрафующий член $ \left(\ts{x(\tau),c}-\gamma\right)^2$ в выражение для $V(t,x)$, тем самым обеспечивая  для $\mathcal{X}[t,t_0]$ включение только тех траекторий, которые удовлетворяют нашим двум системам и условию на момент переключения.
$$
V(t,x)=\min_{u_1 \in\mathcal{P}_1}\max_{v_1\in\mathcal{W}_1}\min_{u_2\in \mathcal{P}_2}\max_{v_2\in\mathcal{W}_2}\max_{\tau}\left\{ d^2(x_0{\mid_{x(t)=x}},\mathcal{X}_0) + \left(\ts{x(\tau),c}-\gamma\right)^2 \right\}.
%V(t,x)=\min_{u_1\in \mathcal{P}_1}\max_{v_1\in\mathcal{W}_1}\left\{ 
$$

Пока примем $\gamma=0$. Для линеаризации условия на переключение сделаем подстановку
$$
\ts{x(\tau),c}^2\equiv\max_\mu \left\{\mu \ts{x(\tau),c} - \frac{\mu^2}{4}\right\},
$$
и, используя \eqref{eq:valued2}, имеем
$$
V(t,x)=\min_{u_1 \in\mathcal{P}_1}\max_{v_1\in\mathcal{W}_1}\min_{u_2\in \mathcal{P}_2}\max_{v_2\in\mathcal{W}_2}\max_{\tau}\left\{
\max_{\ell}\max_{\mu} \left\{\ts{\ell,x_0\mid_{x(t)=x}} +\mu\ts{x(\tau),c}-\frac{\mu^2}{4}- \rho(\ell\mid\mathcal{X}_0)-\frac{\|\ell\|^2}{4}
\right\}\right\}.
$$

Раскрывая \eqref{eq:solvex0}, получим

$$
\begin{gathered}
 V(t,x)=\min_{u_1 \in\mathcal{P}_1}\max_{v_1\in\mathcal{W}_1}\min_{u_2\in \mathcal{P}_2}\max_{v_2\in\mathcal{W}_2}\min_{\tau\in[t_0,t]} \max_{\ell}\max_{\mu} \{  \\
 \ts{\ell,G_1(t_0,\tau)G_2(\tau,t)x} + \int\limits_t^\tau \ts{\ell,G_1(t_0,\tau)G_2(\tau,s)\left[B_2(s)u_2(s)+C_2(s)v_2(s)\right]}\,ds+ \\ 
 + \int\limits_\tau^{t_0} \ts{\ell,G_1(t_0,s)\left[B_1(s)u_1(s)+C_1(s)v_1(s)\right]}\,ds + \mu\ts{c,G_2(\tau,t)x}+ \\
 + \mu\int\limits_t^\tau \ts{c,G_2(\tau,s)\left[B_2(s)u_2(s)+C_2(s)v_2(s)\right]}\,ds-\\
 - \frac{\mu^2}{4} - \rho(\ell\mid\mathcal{X}_0)-\frac{\|\ell\|^2}{4}  \}
\end{gathered}
$$
Сгруппируем слагаемые
$$
\begin{aligned}
\tilde{S}(\tau,t)&= \ell^T G_1(t_0,\tau)G_2(\tau,t)   + \mu c^T G_2(\tau,t),\\
\tilde{S}_1(t_0,\tau)&=\ell^T G_1(t_0,\tau) ,
\end{aligned}
$$
получим
\begin{equation}
\label{eq:big_valuef}
\begin{gathered}
 V(t,x)=\min_{u_1 \in\mathcal{P}_1}\max_{v_1\in\mathcal{W}_1}\min_{u_2\in \mathcal{P}_2}\max_{v_2\in\mathcal{W}_2}\min_{\tau\in[t_0,t]} \max_{\ell}\max_{\mu} \{  \\
  \tilde{S}(\tau,t)x + \int\limits_t^\tau \tilde{S}(\tau,s)\left[B_2(s)u_2(s)+C_2(s)v_2(s)\right]\,ds+ \\ 
 + \int\limits_\tau^{t_0} \tilde{S}_1(t_0,s)\left[B_1(s)u_1(s)+C_1(s)v_1(s)\right]\,ds - \\
 - \frac{\mu^2}{4} - \rho(\ell\mid\mathcal{X}_0)-\frac{\|\ell\|^2}{4}  \}
\end{gathered}
\end{equation}


Чтобы эффективно вычислять множества достижимости используется прием, который позволяет заменить поиск множества допустимых траекторий вычислением опорной функции к этому множетсву. Для перехода к опорным функциям требуется менять местами порядок минимумов и максимумов в \eqref{eq:big_valuef}, а для этого необходимо выполнение условий теоремы минимакса. Поэтому дальнейшие преобразования выполняются с целью обеспечения этих условий. Одним из достаточных условий перестановки является линейность по минимизирующему или максимизирующему параметру. Наша цель состоим в том, чтобы перенести операции минимума по $u_1,u_2$ и максимума по $v_1,v_2$ внутрь выражения функции цены, тем самым сводя минимизацию/максимизацию на пространстве функций  к минимизации/максимизации на евклидовом пространстве. Первыми меняются местами $\max_{v_2}\min_\tau(\cdot)=\min_\tau\max_{v_2}(\cdot)$. Для примера, рассмотрим функционал
$$
T(\tau,v(s))=\int\limits_t^{\tau}v(s)ds 
$$
Легко видеть, что $T(\tau,v(s))$, являясь линейным по $v$, не является таковым по $\tau$. Для этого, вместо $\tau$ возьмем функцию  $\tau(w)=\phi(w)$ и преобразуем 
$$
T(\phi(w),v(s))=\int\limits_{t_0}^t \phi(w)dw \int\limits_t^{w}v(s)ds.
$$
Мы подразумеваем здесь, что $\phi(w)-\delta(w)$.
Теперь функционал $T(\phi,v)$ является линейным по всем аргументам. 

Таким же образом мы поступим с $V(t,x)$:
$$
\begin{gathered}
 V(t,x)=\min_{u_1 \in\mathcal{P}_1}\max_{v_1\in\mathcal{W}_1}\min_{u_2\in \mathcal{P}_2}\max_{v_2\in\mathcal{W}_2}\min_{\phi(w)} \max_{\ell}\max_{\mu}\int\limits_{t_0}^t \phi(w)\bigg\{  \\
  \tilde{S}(w,t)x + \int\limits_t^w \tilde{S}(w,s)\left[B_2(s)u_2(s)+C_2(s)v_2(s)\right]\,ds+  \\
 + \int\limits_w^{t_0} \tilde{S}_1(t_0,s)\left[B_1(s)u_1(s)+C_1(s)v_1(s)\right]\,ds - \\
 - \frac{\mu^2}{4} - \rho(\ell\mid\mathcal{X}_0)-\frac{\|\ell\|^2}{4}  \bigg\}\,dw,
\end{gathered}
$$
Поскольку мы здесь воспользовались перестановкой 
$$\int\max_{\ell,\mu} f(w,\ell,\mu) dw = \max_{\ell(w),\mu(w)}\int f(w,\ell(w),\mu(w))dw,$$
$\ell,\mu$ теперь функции от $w$, $\ell=\ell(w)$ и $\mu=\mu(w)$.
Можно заметить, что от $w$ зависят только переменные $\tilde{S},\tilde{S}_1$ и пределы интегрирования. Поменяем порядок интегрирования, чтобы собрать вместе члены, зависящие от $w$. Применяя правила замены
$$
\int\limits_{t_0}^t dw\int\limits_t^w ds(\cdot) =\int\limits_t^{t_0} ds \int\limits_{t_0}^s dw (\cdot),
$$
$$
\int\limits_{t_0}^t dw\int\limits_w^{t_0} ds(\cdot) =\int\limits_t^{t_0} ds \int\limits_{s}^t dw (\cdot),
$$
и делая замену переменных
$$
\begin{aligned}
S(t_0,t_1)&=\intd{t_0}{t_1}\phi(w)\tilde{S}(w,t_1)\,dw=\int\limits^{t_1}_{t_0}\phi(w)\left\{  \ell^T G_1(t_0,w)G_2(w,t)+ \mu c^T G_2(w,t) \right\}\,dw, \\
S_1(t_0,t_1)&=\intd{t_0}{t_1}\phi(w)\tilde{S}_1(t_0,w)\,dw,=\intd{t_1}{t_0}\phi(w)\left\{ \ell^T G_1(t_0,w) \right\}\,dw,
\end{aligned}
$$
придем к 
\begin{equation}
\label{eq:value_w}
\begin{gathered}
 V(t,x)=\min_{u_1 \in\mathcal{P}_1}\max_{v_1\in\mathcal{W}_1}\min_{u_2\in \mathcal{P}_2}\max_{v_2\in\mathcal{W}_2}\min_{\phi(w)} \max_{\ell(w)}\max_{\mu(w)} \bigg\{  \\
  S(t_0,t)x + \intd{t}{t_0} S(t_0,s)\left[B_2(s)u_2(s)+C_2(s)v_2(s)\right]\,ds+  \\
 + \intd{t}{t_0} S_1(s,t)\left[B_1(s)u_1(s)+C_1(s)v_1(s)\right]\,ds - \\
 - \frac{\mu^2}{4} - \rho(\ell\mid\mathcal{X}_0)-\frac{\|\ell\|^2}{4}  \bigg\}.
\end{gathered}
\end{equation}

Будем искать опорную функцию к множеству достижимости $\mathcal{X}[t,\mathcal{X}_0]$, определяемому по найденному выше выражению \eqref{eq:value_w} для $V(t,x)$. 
Пользуясь линейностью по $\phi(w)$, теперь можно переставить
$$
\max_{v_2\in\mathcal{W}_2}\min_{\phi(w)} \max_{\ell(w)}\max_{\mu(w)} (\cdot)=\min_{\phi(w)} \max_{\ell(w)}\max_{\mu(w)}\max_{v_2\in\mathcal{W}_2}(\cdot),
$$
тогда получим
$$
\begin{gathered}
 V(t,x)=\min_{u_1 \in\mathcal{P}_1}\max_{v_1\in\mathcal{W}_1}\min_{u_2\in \mathcal{P}_2}\min_{\phi(w)} \max_{\ell(w)}\max_{\mu(w)} \bigg\{  \\
  S(t_0,t)x + \intd{t}{t_0} S(t_0,s)B_2(s)u_2(s)\,ds + \intd{t}{t_0}\rho(S(t_0,s)\mid C_2(s)\mathcal{W}_2(s)) \,ds \\
 + \intd{t}{t_0} S_1(s,t)\left[B_1(s)u_1(s)+C_1(s)v_1(s)\right]\,ds - \\
 - \frac{\mu^2}{4} - \rho(\ell\mid\mathcal{X}_0)-\frac{\|\ell\|^2}{4}  \bigg\}.
\end{gathered}
$$
Далее, мы хотим заменить $\min_{u_2}(\cdot)$ опорной функцией, но полученное нами выражение уже не является вогнутым по $\ell,\mu$. Чтобы исправить ситуацию, мы прибегаем к овыпуклению нужных членов и получаем 
$$
\begin{gathered}
 V(t,x)=\min_{u_1 \in\mathcal{P}_1}\max_{v_1\in\mathcal{W}_1}\min_{\phi(w)} \max_{\ell(w)}\max_{\mu(w)} \bigg\{  \\
  S(t_0,t)x - \intd{t_0}{t} \rho(S(t_0,s)\mid B_2(s)\mathcal{P}_2(s))\,ds+\intd{t}{t_0} S_1(s,t)\left[B_1(s)u_1(s)+C_1(s)v_1(s)\right]\,ds \\
   - \mbox{conv}\left\{ -\intd{t}{t_0}\rho(S(t_0,s)\mid C_2(s)\mathcal{W}_2(s)) \,ds + \frac{\mu^2}{4} + \rho(\ell\mid\mathcal{X}_0)+\frac{\|\ell\|^2}{4}\right\}   \bigg\}.
\end{gathered}
$$
Аналогично, $\max_{v_1}$ переставляется также как и $\max_{v_2}$, имеем

$$
\begin{gathered}
 V(t,x)=\min_{u_1 \in\mathcal{P}_1}\min_{\phi(w)} \max_{\ell(w)}\max_{\mu(w)} \bigg\{  \\
  S(t_0,t)x - \intd{t_0}{t} S_1(s,t)B_1(s)u_1(s)\,ds +\intd{t}{t_0}\rho(S_1(s,t)\mid C_1(s)\mathcal{W}_1(s))\,ds - \intd{t_0}{t} \rho(S(t_0,s)\mid B_2(s)\mathcal{P}_2(s))\,ds\\
  - \mbox{conv}\left\{ -\intd{t}{t_0}\rho(S(t_0,s)\mid C_2(s)\mathcal{W}_2(s)) \,ds + \frac{\mu^2}{4} + \rho(\ell\mid\mathcal{X}_0)+\frac{\|\ell\|^2}{4}\right\}   \bigg\}.
\end{gathered}
$$


Опять сталкиваемся с ситуацией овыпукления:
$$
\begin{gathered}
 V(t,x)=\min_{\phi(w)} \max_{\ell(w)}\max_{\mu(w)} \bigg\{  \\
  S(t_0,t)x - \intd{t_0}{t} \rho(S_1(s,t)\mid B_1(s)\mathcal{P}_1(s))\,ds - \intd{t_0}{t} \rho(S(t_0,s)\mid B_2(s)\mathcal{P}_2(s))\,ds + \\ +\mbox{conc} 	\bigg\{\intd{t}{t_0}\rho(S_1(s,t)\mid C_1(s)\mathcal{W}_1(s))\,ds -\\
  - \mbox{conv}\left\{ -\intd{t}{t_0}\rho(S(t_0,s)\mid C_2(s)\mathcal{W}_2(s)) \,ds + \frac{\mu^2}{4} + \rho(\ell\mid\mathcal{X}_0)+\frac{\|\ell\|^2}{4}\right\}   \bigg\}\bigg\},
\end{gathered}
$$
и наконец
$$
\begin{gathered}
 V(t,x)=\min_{\phi(w)} \max_{\ell(w)}\max_{\mu(w)} \bigg\{  \\
  S(t_0,t)x - \intd{t_0}{t} \rho(S_1(s,t)\mid B_1(s)\mathcal{P}_1(s))\,ds - \intd{t_0}{t} \rho(S(t_0,s)\mid B_2(s)\mathcal{P}_2(s))\,ds + \\ +\mbox{conc} 	\bigg\{\intd{t}{t_0}\rho(S_1(s,t)\mid C_1(s)\mathcal{W}_1(s))\,ds + \intd{t}{t_0}\rho(S(t_0,s)\mid C_2(s)\mathcal{W}_2(s)) \,ds - \frac{\mu^2}{4} - \rho(\ell\mid\mathcal{X}_0)-\frac{\|\ell\|^2}{4}\right\}   \bigg\}\bigg\}.
\end{gathered}
$$

